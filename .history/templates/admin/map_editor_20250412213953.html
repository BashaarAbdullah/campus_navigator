{% extends "layout.html" %}

{% block title %}Map Editor - {{ map_name }} (Floor {{ current_floor }}){% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/svg_editor.css') }}">
{% endblock %}

{% block content %}
<section class="map-editor">
    <div class="container">
        <div class="editor-header">
            <h1>
                <span id="map-title">{{ map_name }}</span>
                {% if map_type == 'building' %}
                <span class="floor-indicator">Floor {{ current_floor }}</span>
                {% endif %}
            </h1>
            <div class="editor-controls">
                {% if map_type == 'building' %}
                <div class="floor-selector">
                    <select id="floor-select" aria-label="Select floor">
                        {% for floor in available_floors %}
                        <option value="{{ floor }}" {% if floor == current_floor %}selected{% endif %}>
                            Floor {{ floor }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <button id="save-map" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save
                </button>
                <button id="reset-map" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>

        <div class="editor-toolbar">
            <!-- Tool buttons remain unchanged -->
        </div>

        <div class="editor-container">
            <div id="svg-editor" class="svg-editor">
                {% include map_path %}
            </div>

            <div class="editor-sidebar">
                <!-- Node properties panel remains unchanged -->
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/svg_editor.js') }}"></script>
<script>
    window.mapData = {
        name: "{{ map_name }}",
        type: "{{ map_type }}",
        nodes: {{ nodes|tojson }},
        edges: {{ edges|tojson }}
    };

    document.addEventListener('DOMContentLoaded', () => {
        const floorSelect = document.getElementById('floor-select');
        if (floorSelect) {
            floorSelect.addEventListener('change', function() {
                const url = new URL(window.location.href);
                url.searchParams.set('floor', this.value);
                window.location.href = url.toString();
            });
        }
    });
</script>
{% endblock %}