{% extends "layout.html" %}

{% block title %}Map Editor - {{ map_name|title }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/svg_editor.css') }}">
<style>
    .editor-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
    }
    .editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .tool-group {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    .btn-tool {
        padding: 5px 10px;
        background: white;
        border: 1px solid #ced4da;
    }
    .btn-tool.active {
        background: #007bff;
        color: white;
    }
    #svg-editor {
        flex-grow: 1;
        border: 1px solid #dee2e6;
        overflow: hidden;
    }
    .floor-selector select {
        min-width: 120px;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="editor-toolbar">
        <div class="tool-group">
            <button id="add-node" class="btn btn-tool active" title="Add new node">
                <i class="fas fa-map-marker-alt"></i> Node
            </button>
            <button id="add-edge" class="btn btn-tool" title="Connect nodes">
                <i class="fas fa-route"></i> Edge
            </button>
            <button id="delete-mode" class="btn btn-tool" title="Delete items">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
        
        <div class="tool-group">
            <button id="zoom-in" class="btn btn-tool" title="Zoom in">
                <i class="fas fa-search-plus"></i>
            </button>
            <button id="zoom-out" class="btn btn-tool" title="Zoom out">
                <i class="fas fa-search-minus"></i>
            </button>
            <button id="fit-view" class="btn btn-tool" title="Reset view">
                <i class="fas fa-expand"></i>
            </button>
        </div>
        
        <div class="tool-group">
            <button id="save-map" class="btn btn-primary" title="Save changes">
                <i class="fas fa-save"></i> Save
            </button>
            <button id="reset-map" class="btn btn-secondary" title="Discard changes">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
        
        {% if map_type == 'building' %}
        <div class="tool-group floor-selector">
            <select id="floor-select" class="form-control form-control-sm">
                {% for floor in available_floors %}
                <option value="{{ floor }}" {% if floor == current_floor %}selected{% endif %}>
                    Floor {{ floor }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    <div id="svg-editor">
        {% include map_path %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/svg_editor.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize editor with current map data
    window.editor = new SVGEditor('svg-editor', {
        nodes: {{ nodes|tojson }},
        edges: {{ edges|tojson }}
    });
    
    // Handle floor switching
    const floorSelect = document.getElementById('floor-select');
    if (floorSelect) {
        floorSelect.addEventListener('change', function() {
            const url = new URL(window.location.href);
            url.searchParams.set('floor', this.value);
            window.location.href = url.toString();
        });
    }
});
</script>
{% endblock %}